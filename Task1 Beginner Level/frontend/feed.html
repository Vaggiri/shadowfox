<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="/favicon.png">
    <title>Posts Feed | Portfolio</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Outfit:wght@400;500;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="./linkedin-theme.css">
    <link rel="stylesheet" href="./feed-styles.css">
</head>

<body class="feed-body">
    <!-- Mobile Back Button -->
    <a href="#" onclick="history.back(); return false;" class="mobile-back-btn" aria-label="Go Back">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
            stroke-linejoin="round" width="24" height="24">
            <line x1="19" y1="12" x2="5" y2="12"></line>
            <polyline points="12 19 5 12 12 5"></polyline>
        </svg>
    </a>

    <!-- Header -->
    <header class="feed-header">
        <div class="header-container">
            <a href="./index.html" class="logo">Portfolio</a>
            <nav class="header-nav">
                <a href="./index.html" class="nav-item">Profile</a>
                <a href="./feed.html" class="nav-item active">Feed</a>
                <a href="./admin-dashboard.html" class="nav-item admin-only" style="display: none;">Dashboard</a>
            </nav>
            <div class="header-right">
                <button id="authBtn" class="btn-secondary">Admin</button>
            </div>
        </div>
    </header>

    <main class="feed-main">
        <div class="feed-container">
            <!-- Create Post (Admin Only) -->
            <div id="createPostSection" class="create-post-card" style="display: none;">
                <div class="create-post-header">
                    <img id="createProfilePhoto" src="/giri.jpg" alt="Profile" class="post-avatar">
                    <textarea id="postContent" placeholder="What do you want to share?" rows="3"></textarea>
                </div>
                <div id="imagePreviewContainer" class="image-preview-container"></div>
                <div class="create-post-actions">
                    <div class="post-options">
                        <button class="option-btn" id="addImageBtn">
                            üñºÔ∏è Photo
                            <input type="file" id="imageInput" accept="image/*" multiple hidden>
                        </button>
                        <button class="option-btn" id="addVideoBtn">üé• Video</button>
                    </div>
                    <button id="publishBtn" class="btn-primary">Post</button>
                </div>
            </div>

            <!-- Video Embed Modal -->
            <div id="videoModal" class="modal" style="display: none;">
                <div class="modal-content">
                    <h3>Add Video URL</h3>
                    <input type="text" id="videoUrl" placeholder="YouTube or Vimeo URL" class="edit-input">
                    <div class="modal-actions">
                        <button id="cancelVideo" class="btn-secondary">Cancel</button>
                        <button id="addVideoUrl" class="btn-primary">Add</button>
                    </div>
                </div>
            </div>

            <!-- Posts Feed -->
            <div id="postsContainer" class="posts-feed"></div>

            <!-- Empty State -->
            <div id="emptyState" class="empty-feed-state" style="display: none;">
                <div class="empty-icon">üìù</div>
                <h3>No posts yet</h3>
                <p>Be the first to share something!</p>
            </div>
        </div>
    </main>

    <script type="module">
        import apiService from './api-service.js';
        import { showToast, generateId, getUserId, formatRelativeTime, compressImage, sanitizeHTML, truncateText } from './utils.js';

        let isAdmin = false;
        let currentImages = [];
        let currentVideoUrl = null;

        // Initialize
        async function init() {
            isAdmin = await apiService.isAuthenticated();

            // Show/hide admin features
            if (isAdmin) {
                document.getElementById('createPostSection').style.display = 'block';
                document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'block');
                document.getElementById('authBtn').textContent = 'Dashboard';
                document.getElementById('authBtn').onclick = () => window.location.href = './admin-dashboard.html';

                // Load profile photo for create post
                const profile = await apiService.getProfile();
                document.getElementById('createProfilePhoto').src = profile.profilePhoto;
            } else {
                document.getElementById('authBtn').onclick = () => window.location.href = './admin.html';
            }

            loadPosts();

            // Increment profile views (only once per session)
            if (!sessionStorage.getItem('viewed')) {
                apiService.incrementProfileViews();
                sessionStorage.setItem('viewed', 'true');
            }
        }

        // Image Upload
        document.getElementById('addImageBtn').addEventListener('click', () => {
            document.getElementById('imageInput').click();
        });

        document.getElementById('imageInput').addEventListener('change', async (e) => {
            const files = Array.from(e.target.files);
            const container = document.getElementById('imagePreviewContainer');

            for (const file of files) {
                if (currentImages.length >= 4) {
                    showToast('Maximum 4 images allowed', 'error');
                    break;
                }

                const compressed = await compressImage(file, 800);
                currentImages.push(compressed);

                const preview = document.createElement('div');
                preview.className = 'image-preview-item';
                preview.innerHTML = `
                    <img src="${compressed}" alt="Preview">
                    <button class="remove-image" data-index="${currentImages.length - 1}">√ó</button>
                `;
                container.appendChild(preview);
            }

            // Add remove handlers
            document.querySelectorAll('.remove-image').forEach(btn => {
                btn.onclick = () => {
                    const index = parseInt(btn.dataset.index);
                    currentImages.splice(index, 1);
                    loadImagePreviews();
                };
            });

            e.target.value = '';
        });

        function loadImagePreviews() {
            const container = document.getElementById('imagePreviewContainer');
            container.innerHTML = currentImages.map((img, i) => `
                <div class="image-preview-item">
                    <img src="${img}" alt="Preview">
                    <button class="remove-image" data-index="${i}">√ó</button>
                </div>
            `).join('');

            document.querySelectorAll('.remove-image').forEach(btn => {
                btn.onclick = () => {
                    const index = parseInt(btn.dataset.index);
                    currentImages.splice(index, 1);
                    loadImagePreviews();
                };
            });
        }

        // Video Modal
        document.getElementById('addVideoBtn').addEventListener('click', () => {
            document.getElementById('videoModal').style.display = 'flex';
        });

        document.getElementById('cancelVideo').addEventListener('click', () => {
            document.getElementById('videoModal').style.display = 'none';
            document.getElementById('videoUrl').value = '';
        });

        document.getElementById('addVideoUrl').addEventListener('click', () => {
            const url = document.getElementById('videoUrl').value.trim();
            if (url) {
                currentVideoUrl = url;
                document.getElementById('videoModal').style.display = 'none';
                document.getElementById('videoUrl').value = '';
                showToast('Video added!', 'success');
            }
        });

        // Publish Post
        document.getElementById('publishBtn').addEventListener('click', async () => {
            const content = document.getElementById('postContent').value.trim();

            if (!content && currentImages.length === 0 && !currentVideoUrl) {
                showToast('Post cannot be empty', 'error');
                return;
            }

            const profile = await apiService.getProfile();
            const post = {
                authorName: profile.name,
                authorPhoto: profile.profilePhoto,
                authorHeadline: profile.headline,
                content: sanitizeHTML(content),
                images: [...currentImages],
                videoUrl: currentVideoUrl
            };

            try {
                await apiService.createPost(post);

                // Reset form
                document.getElementById('postContent').value = '';
                currentImages = [];
                currentVideoUrl = null;
                document.getElementById('imagePreviewContainer').innerHTML = '';

                showToast('Post published!', 'success');
                loadPosts();
            } catch (error) {
                showToast('Error publishing post', 'error');
                console.error(error);
            }
        });

        // Render Posts
        async function loadPosts() {
            try {
                const posts = await apiService.getPosts();
                const container = document.getElementById('postsContainer');
                const emptyState = document.getElementById('emptyState');

                if (posts.length === 0) {
                    container.innerHTML = '';
                    emptyState.style.display = 'block';
                    return;
                }

                emptyState.style.display = 'none';

                // Render posts sequentially to handle async stats fetching properly
                // For better performance in a real app, you'd fetch all stats in parallel or have the backend include them
                container.innerHTML = ''; // Clear first to avoid duplicates

                const postsWithStats = await Promise.all(posts.map(async post => {
                    const likes = await apiService.getLikes(post._id);
                    const comments = await apiService.getComments(post._id);
                    const userId = getUserId();
                    const hasLiked = likes.some(l => l.userId === userId);

                    return {
                        ...post,
                        likesCount: likes.length,
                        comments: comments,
                        hasLiked: hasLiked
                    };
                }));

                const html = postsWithStats.map(post => renderPost(post)).join('');
                container.innerHTML = html;
                attachPostEventListeners();
            } catch (error) {
                console.error('Error loading posts:', error);
            }
        }

        function renderPost(post) {
            const showMore = post.content.length > 300;
            const truncated = showMore ? truncateText(post.content, 300) : post.content;
            const comments = post.comments || [];

            return `
                <article class="post-card" data-post-id="${post._id}">
                    <div class="post-header">
                        <img src="${(post.authorPhoto || '/giri.jpg').replace('http://localhost:5173', '')}" alt="${post.authorName}" class="post-avatar">
                        <div class="post-author-info">
                            <h4>${post.authorName}</h4>
                            <p>${post.authorHeadline}</p>
                            <span class="post-time">${formatRelativeTime(new Date(post.createdAt))}</span>
                        </div>
                        ${isAdmin ? `
                            <div class="post-menu">
                                <button class="menu-btn" data-post-id="${post._id}">‚ãÆ</button>
                                <div class="dropdown-menu" style="display: none;">
                                    <button class="delete-post" data-post-id="${post._id}">Delete</button>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="post-content">
                        <p class="post-text ${showMore ? 'truncated' : ''}">${truncated}</p>
                        ${showMore ? `<button class="see-more" data-post-id="${post._id}">See more</button>` : ''}
                        <p class="post-text-full" style="display: none;">${post.content}</p>
                    </div>

                    ${post.images && post.images.length > 0 ? `
                        <div class="post-images ${post.images.length > 1 ? 'grid-' + post.images.length : ''}">
                            ${post.images.map((img, i) => `
                                <img src="${img.replace('http://localhost:5173', '')}" alt="Post image ${i + 1}" class="post-image" data-index="${i}">
                            `).join('')}
                        </div>
                    ` : ''}

                    ${post.videoUrl ? `
                        <div class="post-video">
                            ${getVideoEmbed(post.videoUrl)}
                        </div>
                    ` : ''}

                    <div class="post-stats">
                        <span class="likes-count">${post.likesCount} ${post.likesCount === 1 ? 'like' : 'likes'}</span>
                        <span class="comments-count">${comments.length} ${comments.length === 1 ? 'comment' : 'comments'}</span>
                    </div>

                    <div class="post-actions">
                        <button class="action-btn like-btn ${post.hasLiked ? 'liked' : ''}" data-post-id="${post._id}">
                            <span class="action-icon">${post.hasLiked ? '‚ù§Ô∏è' : 'ü§ç'}</span>
                            Like
                        </button>
                        <button class="action-btn comment-btn" data-post-id="${post._id}">
                            <span class="action-icon">üí¨</span>
                            Comment
                        </button>
                        <button class="action-btn share-btn" data-post-id="${post._id}">
                            <span class="action-icon">üîó</span>
                            Share
                        </button>
                    </div>

                    <div class="comments-section" id="comments-${post._id}" style="${comments.length > 0 ? '' : 'display: none;'}">
                        <div class="comments-list">
                            ${comments.map(comment => renderComment(comment, post._id)).join('')}
                        </div>
                    </div>

                    <div class="comment-input-section" style="display: none;">
                        <div class="comment-input-wrapper">
                            <input type="text" class="commenter-name" placeholder="Your name" data-post-id="${post._id}">
                            <textarea class="comment-input" placeholder="Write a comment..." data-post-id="${post._id}" rows="1"></textarea>
                            <button class="submit-comment" data-post-id="${post._id}">Post</button>
                        </div>
                    </div>
                </article>
            `;
        }

        function renderComment(comment, postId) {
            return `
                <div class="comment-item" data-comment-id="${comment._id}">
                    <div class="comment-avatar">${comment.userName && comment.userName.length > 0 ? comment.userName.charAt(0).toUpperCase() : '?'}</div>
                    <div class="comment-content">
                        <div class="comment-header">
                            <strong>${comment.userName}</strong>
                            <span class="comment-time">${formatRelativeTime(comment.createdAt)}</span>
                        </div>
                        <p>${comment.content}</p>
                        ${isAdmin ? `<button class="delete-comment" data-post-id="${postId}" data-comment-id="${comment._id}">Delete</button>` : ''}
                    </div>
                </div>
            `;
        }

        function getVideoEmbed(url) {
            if (!url) return '';
            // YouTube
            if (url.includes('youtube.com') || url.includes('youtu.be')) {
                const videoId = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([^&]+)/)?.[1];
                if (videoId) {
                    return `<iframe src="https://www.youtube.com/embed/${videoId}" frameborder="0" allowfullscreen></iframe>`;
                }
            }
            // Vimeo
            if (url.includes('vimeo.com')) {
                const videoId = url.match(/vimeo\.com\/(\d+)/)?.[1];
                if (videoId) {
                    return `<iframe src="https://player.vimeo.com/video/${videoId}" frameborder="0" allowfullscreen></iframe>`;
                }
            }
            return `<a href="${url}" target="_blank">${url}</a>`;
        }

        function attachPostEventListeners() {
            // Like buttons
            document.querySelectorAll('.like-btn').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const postId = btn.dataset.postId;
                    const userId = getUserId();
                    await apiService.toggleLike(postId, userId);
                    loadPosts();
                });
            });

            // Comment buttons
            document.querySelectorAll('.comment-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const postId = btn.dataset.postId;
                    const input = document.querySelector(`[data-post-id="${postId}"].comment-input`).closest('.comment-input-section');
                    input.style.display = input.style.display === 'none' ? 'block' : 'none';
                });
            });

            // Submit comment
            document.querySelectorAll('.submit-comment').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const postId = btn.dataset.postId;
                    const nameInput = document.querySelector(`.commenter-name[data-post-id="${postId}"]`);
                    const contentInput = document.querySelector(`.comment-input[data-post-id="${postId}"]`);
                    const name = nameInput.value.trim();
                    const content = contentInput.value.trim();

                    if (!name) {
                        showToast('Please enter your name', 'error');
                        return;
                    }

                    if (!content) {
                        showToast('Comment cannot be empty', 'error');
                        return;
                    }

                    const comment = {
                        userName: sanitizeHTML(name),
                        content: sanitizeHTML(content)
                    };

                    try {
                        await apiService.addComment(postId, comment);
                        nameInput.value = '';
                        contentInput.value = '';
                        showToast('Comment added!', 'success');
                        loadPosts();
                    } catch (error) {
                        showToast('Error adding comment', 'error');
                    }
                });
            });

            // Delete post
            document.querySelectorAll('.delete-post').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const postId = btn.dataset.postId;
                    if (confirm('Are you sure you want to delete this post?')) {
                        try {
                            await apiService.deletePost(postId);
                            showToast('Post deleted', 'success');
                            loadPosts();
                        } catch (error) {
                            showToast('Error deleting post', 'error');
                        }
                    }
                });
            });

            // Delete comment
            document.querySelectorAll('.delete-comment').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const postId = btn.dataset.postId;
                    const commentId = btn.dataset.commentId;
                    try {
                        await apiService.deleteComment(postId, commentId);
                        showToast('Comment deleted', 'success');
                        loadPosts();
                    } catch (error) {
                        showToast('Error deleting comment', 'error');
                    }
                });
            });

            // Menu toggle
            document.querySelectorAll('.menu-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const menu = btn.nextElementSibling;
                    menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
                });
            });

            // See more/less
            document.querySelectorAll('.see-more').forEach(btn => {
                btn.addEventListener('click', () => {
                    const postContent = btn.closest('.post-content');
                    const truncated = postContent.querySelector('.post-text');
                    const full = postContent.querySelector('.post-text-full');

                    if (truncated.classList.contains('truncated')) {
                        truncated.style.display = 'none';
                        full.style.display = 'block';
                        btn.textContent = 'See less';
                    } else {
                        truncated.style.display = 'block';
                        full.style.display = 'none';
                        btn.textContent = 'See more';
                    }
                    truncated.classList.toggle('truncated');
                });
            });

            // Share
            document.querySelectorAll('.share-btn').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const url = window.location.href;
                    try {
                        await navigator.clipboard.writeText(url);
                        showToast('Link copied to clipboard!', 'success');
                    } catch (err) {
                        showToast('Failed to copy link', 'error');
                    }
                });
            });
        }

        // Close menus when clicking outside
        document.addEventListener('click', () => {
            document.querySelectorAll('.dropdown-menu').forEach(menu => {
                menu.style.display = 'none';
            });
        });

        // Start
        init();
    </script>
</body>

</html>