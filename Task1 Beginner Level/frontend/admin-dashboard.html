<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="/favicon.png">
    <title>Admin Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Outfit:wght@400;500;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="./linkedin-theme.css">
</head>

<body class="admin-body">
    <!-- Mobile Back Button -->
    <a href="#" onclick="history.back(); return false;" class="mobile-back-btn" aria-label="Go Back">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
            stroke-linejoin="round" width="24" height="24">
            <line x1="19" y1="12" x2="5" y2="12"></line>
            <polyline points="12 19 5 12 12 5"></polyline>
        </svg>
    </a>

    <!-- LinkedIn-style Header -->
    <header class="admin-header">
        <div class="header-container">
            <div class="header-left">
                <h1>Portfolio Admin</h1>
            </div>
            <nav class="header-nav">
                <a href="#dashboard" class="nav-item active">Dashboard</a>
                <a href="#profile" class="nav-item">Profile</a>
                <a href="#projects" class="nav-item">Projects</a>
                <a href="#certifications" class="nav-item">Certifications</a>
                <a href="./feed.html" class="nav-item">Posts</a>
                <a href="./index.html" class="nav-item">View Site</a>
            </nav>
            <div class="header-right">
                <button id="logoutBtn" class="btn-logout">Logout</button>
            </div>
        </div>
    </header>

    <main class="admin-main">
        <!-- Dashboard View -->
        <section id="dashboardSection" class="admin-section active">
            <div class="section-header">
                <h2>Dashboard Overview</h2>
                <button id="exportDataBtn" class="btn-secondary">Export Data</button>
            </div>

            <!-- Analytics Cards -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">üëÅÔ∏è</div>
                    <div class="stat-content">
                        <h3 id="profileViews">0</h3>
                        <p>Profile Views</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üìù</div>
                    <div class="stat-content">
                        <h3 id="totalPosts">0</h3>
                        <p>Total Posts</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚ù§Ô∏è</div>
                    <div class="stat-content">
                        <h3 id="totalLikes">0</h3>
                        <p>Total Likes</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üí¨</div>
                    <div class="stat-content">
                        <h3 id="totalComments">0</h3>
                        <p>Total Comments</p>
                    </div>
                </div>
            </div>

            <!-- Recent Posts -->
            <div class="dashboard-section">
                <div class="section-header">
                    <h3>Recent Posts</h3>
                    <a href="./feed.html#create" class="btn-primary">Create Post</a>
                </div>
                <div id="recentPosts" class="posts-list"></div>
            </div>

            <!-- Recent Comments -->
            <div class="dashboard-section">
                <h3>Recent Comments</h3>
                <div id="recentComments" class="comments-list"></div>
            </div>
        </section>

        <!-- Profile Edit View -->
        <section id="profileSection" class="admin-section">
            <div class="section-header">
                <h2>Edit Profile</h2>
                <button id="saveProfileBtn" class="btn-primary">Save Changes</button>
            </div>

            <div class="profile-edit-container">
                <!-- Banner Image -->
                <div class="edit-group">
                    <label>Banner Image</label>
                    <div class="image-upload-box" id="bannerUpload">
                        <img id="bannerPreview" src="" alt="Banner" style="display: none;">
                        <div class="upload-placeholder">
                            <span>üì∑</span>
                            <p>Click to upload banner image</p>
                        </div>
                        <input type="file" id="bannerInput" accept="image/*" hidden>
                    </div>
                </div>

                <!-- Profile Photo -->
                <div class="edit-group">
                    <label>Profile Photo</label>
                    <div class="profile-photo-upload">
                        <img id="profilePhotoPreview" src="/giri.jpg" alt="Profile">
                        <button class="change-photo-btn" id="changePhotoBtn">Change Photo</button>
                        <input type="file" id="profilePhotoInput" accept="image/*" hidden>
                    </div>
                </div>

                <!-- Basic Info -->
                <div class="edit-group">
                    <label>Full Name</label>
                    <input type="text" id="profileName" class="edit-input" placeholder="Your name">
                </div>

                <div class="edit-group">
                    <label>Headline</label>
                    <input type="text" id="profileHeadline" class="edit-input" placeholder="Professional headline">
                </div>

                <div class="edit-group">
                    <label>About</label>
                    <textarea id="profileAbout" class="edit-textarea" rows="6"
                        placeholder="Tell us about yourself"></textarea>
                </div>

                <!-- Contact Info -->
                <div class="edit-group">
                    <label>Location</label>
                    <input type="text" id="profileLocation" class="edit-input" placeholder="City, State, Country">
                </div>

                <div class="edit-group">
                    <label>Email</label>
                    <input type="email" id="profileEmail" class="edit-input" placeholder="your@email.com">
                </div>

                <!-- Skills -->
                <div class="edit-group">
                    <label>Skills</label>
                    <div class="skills-manager">
                        <div class="skill-input-row">
                            <input type="text" id="newSkillCategory" class="edit-input"
                                placeholder="Category (e.g. Languages)" style="width: 40%;">
                            <input type="text" id="newSkillInput" class="edit-input" placeholder="Skill Name">
                            <button id="addSkillBtn" class="btn-primary">Add</button>
                        </div>
                        <div id="skillsList" class="skills-edit-list"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Projects Management Section -->
        <section id="projectsSection" class="admin-section">
            <div class="section-header">
                <h2>Manage Projects</h2>
                <button id="addProjectBtn" class="btn-primary">Add New Project</button>
            </div>

            <div id="projectsList" class="content-list"></div>

            <!-- Add/Edit Project Modal -->
            <div id="projectModal" class="modal" style="display: none;">
                <div class="modal-content" style="max-width: 700px;">
                    <h3 id="projectModalTitle">Add New Project</h3>
                    <input type="hidden" id="editProjectId">

                    <div class="edit-group">
                        <label>Project Title</label>
                        <input type="text" id="projectTitle" class="edit-input" placeholder="Project name">
                    </div>

                    <div class="edit-group">
                        <label>Description</label>
                        <textarea id="projectDescription" class="edit-textarea" rows="4"
                            placeholder="Project description"></textarea>
                    </div>

                    <div class="edit-group">
                        <label>Tags (comma separated)</label>
                        <input type="text" id="projectTags" class="edit-input" placeholder="React, Node.js, MongoDB">
                    </div>

                    <div class="edit-group">
                        <label>Start Date</label>
                        <input type="month" id="projectStartDate" class="edit-input">
                    </div>

                    <div class="edit-group">
                        <label>End Date (leave empty if ongoing)</label>
                        <input type="month" id="projectEndDate" class="edit-input">
                    </div>

                    <div class="edit-group">
                        <label>Project Images (up to 3)</label>
                        <div class="image-upload-grid" id="projectImagesGrid"></div>
                        <button type="button" class="btn-secondary" id="addProjectImageBtn">+ Add Image</button>
                        <input type="file" id="projectImageInput" accept="image/*" hidden>
                    </div>

                    <div class="modal-actions">
                        <button id="cancelProject" class="btn-secondary">Cancel</button>
                        <button id="saveProject" class="btn-primary">Save Project</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Certifications Management Section -->
        <section id="certificationsSection" class="admin-section">
            <div class="section-header">
                <h2>Manage Certifications</h2>
                <button id="addCertBtn" class="btn-primary">Add New Certification</button>
            </div>

            <div id="certificationsList" class="content-list"></div>

            <!-- Add/Edit Certification Modal -->
            <div id="certModal" class="modal" style="display: none;">
                <div class="modal-content">
                    <h3 id="certModalTitle">Add New Certification</h3>
                    <input type="hidden" id="editCertId">

                    <div class="edit-group">
                        <label>Certification Name</label>
                        <input type="text" id="certName" class="edit-input" placeholder="Certification title">
                    </div>

                    <div class="edit-group">
                        <label>Issuer</label>
                        <input type="text" id="certIssuer" class="edit-input" placeholder="Issuing Organization">
                    </div>

                    <div class="edit-group">
                        <label>Date</label>
                        <input type="text" id="certDate" class="edit-input" placeholder="e.g. 2025-12">
                    </div>

                    <div class="edit-group">
                        <label>Credential URL</label>
                        <input type="text" id="certUrl" class="edit-input" placeholder="https://...">
                    </div>

                    <div class="edit-group">
                        <label>Certificate Image</label>
                        <button type="button" class="btn-secondary" id="certImageBtn">Upload Image</button>
                        <input type="file" id="certImageInput" accept="image/*" hidden>
                    </div>
                </div>
            </div>

            <div class="modal-actions">
                <button id="cancelCert" class="btn-secondary">Cancel</button>
                <button id="saveCert" class="btn-primary">Save Certification</button>
            </div>
            </div>
            </div>
        </section>
    </main>


    <!-- Mobile Bottom Navigation -->
    <nav class="mobile-bottom-nav">
        <a href="#dashboard" class="nav-item active">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
                <rect x="3" y="3" width="7" height="7"></rect>
                <rect x="14" y="3" width="7" height="7"></rect>
                <rect x="14" y="14" width="7" height="7"></rect>
                <rect x="3" y="14" width="7" height="7"></rect>
            </svg>
            <span>Home</span>
        </a>
        <a href="#profile" class="nav-item">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
            </svg>
            <span>Profile</span>
        </a>
        <a href="#projects" class="nav-item">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
                <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
            </svg>
            <span>Projects</span>
        </a>
        <a href="#certifications" class="nav-item">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                <polyline points="22 4 12 14.01 9 11.01"></polyline>
            </svg>
            <span>Certs</span>
        </a>
        <a href="./feed.html" class="nav-item">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
            </svg>
            <span>Post</span>
        </a>
    </nav>

    <script type="module">
        import apiService from './api-service.js';
        import { showToast, compressImage, downloadJSON, formatRelativeTime } from './utils.js';

        // Check authentication

        // Check authentication
        async function init() {
            if (!await apiService.isAuthenticated()) {
                window.location.href = './admin.html';
            }
        }
        init();

        // Navigation
        const navItems = document.querySelectorAll('.nav-item');
        const sections = document.querySelectorAll('.admin-section');

        navItems.forEach(item => {
            item.addEventListener('click', (e) => {
                if (item.getAttribute('href').startsWith('#')) {
                    e.preventDefault();
                    const target = item.getAttribute('href').substring(1);

                    navItems.forEach(n => n.classList.remove('active'));
                    item.classList.add('active');

                    sections.forEach(s => s.classList.remove('active'));
                    document.getElementById(`${target}Section`).classList.add('active');
                }
            });
        });

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            await apiService.logout();
            showToast('Logged out successfully', 'success');
            setTimeout(() => {
                window.location.href = './admin.html';
            }, 500);
        });

        // Load Analytics
        async function loadAnalytics() {
            try {
                const analytics = await apiService.getAnalytics();
                const posts = await apiService.getPosts();

                // Calculate totals
                let totalComments = 0;
                let totalLikes = 0;

                for (const post of posts) {
                    const comments = await apiService.getComments(post._id);
                    const likes = await apiService.getLikes(post._id);
                    totalComments += comments.length;
                    totalLikes += likes.length;
                }

                document.getElementById('profileViews').textContent = analytics.profileViews || 0;
                document.getElementById('totalPosts').textContent = posts.length;
                document.getElementById('totalLikes').textContent = totalLikes;
                document.getElementById('totalComments').textContent = totalComments;
            } catch (error) {
                console.error('Error loading analytics:', error);
            }
        }

        // Load Recent Posts
        async function loadRecentPosts() {
            try {
                const allPosts = await apiService.getPosts();
                const posts = allPosts.slice(0, 5);
                const container = document.getElementById('recentPosts');

                if (posts.length === 0) {
                    container.innerHTML = '<p class="empty-state">No posts yet. <a href="./feed.html#create">Create your first post</a></p>';
                    return;
                }

                // Fetch stats for each post
                const postsWithStats = await Promise.all(posts.map(async post => {
                    const likes = await apiService.getLikes(post._id);
                    const comments = await apiService.getComments(post._id);
                    return { ...post, likesCount: likes.length, commentsCount: comments.length };
                }));

                container.innerHTML = postsWithStats.map(post => `
                    <div class="post-item">
                        <div class="post-content">
                            <p>${post.content.substring(0, 100)}...</p>
                            <span class="post-meta">${formatRelativeTime(post.createdAt)}</span>
                        </div>
                        <div class="post-stats">
                            <span>‚ù§Ô∏è ${post.likesCount}</span>
                            <span>üí¨ ${post.commentsCount}</span>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading recent posts:', error);
            }
        }

        // Load Recent Comments
        async function loadRecentComments() {
            // This is resource intensive with separate endpoints, skipping for MVP or implementing a dedicated endpoint
            const container = document.getElementById('recentComments');
            container.innerHTML = '<p class="empty-state">Recent comments view coming soon via aggregated API.</p>';
        }

        // Export Data
        document.getElementById('exportDataBtn').addEventListener('click', async () => {
            // Simplified export
            const profile = await apiService.getProfile();
            const posts = await apiService.getPosts();
            const skills = await apiService.getSkills();

            const data = { profile, posts, skills };
            downloadJSON(data);
            showToast('Data exported successfully!', 'success');
        });

        // Profile Management
        async function loadProfile() {
            try {
                const profile = await apiService.getProfile();
                document.getElementById('profileName').value = profile.name || '';
                document.getElementById('profileHeadline').value = profile.headline || '';
                document.getElementById('profileAbout').value = profile.about || '';
                document.getElementById('profileLocation').value = profile.location || '';
                document.getElementById('profileEmail').value = profile.email || '';

                if (profile.bannerImage) {
                    document.getElementById('bannerPreview').src = profile.bannerImage;
                    document.getElementById('bannerPreview').style.display = 'block';
                    document.querySelector('#bannerUpload .upload-placeholder').style.display = 'none';
                }

                if (profile.profilePhoto) {
                    document.getElementById('profilePhotoPreview').src = profile.profilePhoto;
                }

                loadSkills();
            } catch (error) {
                console.error('Error loading profile:', error);
            }
        }

        // Skills Management
        async function loadSkills() {
            try {
                const skills = await apiService.getSkills();
                const container = document.getElementById('skillsList');

                // Group by Category
                const categories = {};
                skills.forEach(skill => {
                    const cat = skill.category || 'Other';
                    if (!categories[cat]) categories[cat] = [];
                    categories[cat].push(skill);
                });

                container.innerHTML = Object.keys(categories).sort().map(cat => `
                    <div class="skill-category-group">
                        <div class="category-header">
                            <h4>${cat}</h4>
                            <button class="btn-text edit-category-btn" data-category="${cat}">Rename</button>
                        </div>
                        <div class="category-skills">
                            ${categories[cat].map(skill => `
                                <div class="skill-tag-edit">
                                    <span class="skill-name" data-id="${skill._id}" data-cat="${cat}">${skill.name}</span>
                                    <div class="skill-actions">
                                        <button class="btn-icon edit-skill-btn" data-id="${skill._id}" data-name="${skill.name}" data-cat="${cat}">‚úé</button>
                                        <button class="remove-skill" data-id="${skill._id}">√ó</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `).join('');

                // Add Handlers

                // Remove Skill
                document.querySelectorAll('.remove-skill').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        if (confirm('Delete this skill?')) {
                            await apiService.deleteSkill(btn.dataset.id);
                            loadSkills();
                            showToast('Skill removed', 'success');
                        }
                    });
                });

                // Edit Skill
                document.querySelectorAll('.edit-skill-btn').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        const newName = prompt('Enter new skill name:', btn.dataset.name);
                        if (newName && newName !== btn.dataset.name) {
                            await apiService.updateSkill(btn.dataset.id, { name: newName, category: btn.dataset.cat });
                            loadSkills();
                            showToast('Skill updated', 'success');
                        }
                    });
                });

                // Rename Category
                document.querySelectorAll('.edit-category-btn').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        const oldCat = btn.dataset.category;
                        const newCat = prompt(`Rename category "${oldCat}" to:`, oldCat);

                        if (newCat && newCat !== oldCat) {
                            if (confirm(`This will move all skills from "${oldCat}" to "${newCat}". Continue?`)) {
                                const skillsToUpdate = categories[oldCat];
                                let updatedCount = 0;

                                for (const skill of skillsToUpdate) {
                                    await apiService.updateSkill(skill._id, { ...skill, category: newCat });
                                    updatedCount++;
                                }

                                loadSkills();
                                showToast(`${updatedCount} skills moved to "${newCat}"`, 'success');
                            }
                        }
                    });
                });

            } catch (error) {
                console.error('Error loading skills:', error);
            }
        }

        // Add Skill
        document.getElementById('addSkillBtn').addEventListener('click', async () => {
            const nameInput = document.getElementById('newSkillInput');
            let catInput = document.getElementById('newSkillCategory');

            const skillName = nameInput.value.trim();
            const category = catInput ? catInput.value.trim() : 'Other';

            if (!skillName) {
                showToast('Skill name is required', 'error');
                return;
            }

            try {
                await apiService.addSkill({ name: skillName, category: category });
                loadSkills();
                nameInput.value = '';
                if (catInput) catInput.value = '';
                showToast('Skill added!', 'success');
            } catch (error) {
                showToast('Error adding skill', 'error');
            }
        });

        // Profile Photo Upload (Simplified)
        document.getElementById('changePhotoBtn').addEventListener('click', () => {
            document.getElementById('profilePhotoInput').click();
        });

        document.getElementById('profilePhotoInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                const compressed = await compressImage(file, 400);
                document.getElementById('profilePhotoPreview').src = compressed;
                showToast('Photo staged for save', 'info');
            }
        });

        // Banner Upload
        document.getElementById('bannerUpload').addEventListener('click', () => {
            document.getElementById('bannerInput').click();
        });

        document.getElementById('bannerInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                const compressed = await compressImage(file, 1200);
                document.getElementById('bannerPreview').src = compressed;
                document.getElementById('bannerPreview').style.display = 'block';
                document.querySelector('#bannerUpload .upload-placeholder').style.display = 'none';
                showToast('Banner staged for save', 'info');
            }
        });

        // Save Profile
        document.getElementById('saveProfileBtn').addEventListener('click', async () => {
            const updates = {
                name: document.getElementById('profileName').value,
                headline: document.getElementById('profileHeadline').value,
                about: document.getElementById('profileAbout').value,
                location: document.getElementById('profileLocation').value,
                email: document.getElementById('profileEmail').value,
                profilePhoto: document.getElementById('profilePhotoPreview').src,
                bannerImage: document.getElementById('bannerPreview').src || null
            };

            try {
                await apiService.updateProfile(updates);
                showToast('Profile saved successfully!', 'success');
            } catch (error) {
                showToast('Error saving profile', 'error');
            }
        });

        // ========== PROJECTS MANAGEMENT ==========
        let currentProjectImages = [];

        async function loadProjects() {
            try {
                const projects = await apiService.getProjects();
                const container = document.getElementById('projectsList');

                if (!projects || projects.length === 0) {
                    container.innerHTML = '<p class="empty-state">No projects yet. Click "Add New Project" to get started.</p>';
                    return;
                }

                container.innerHTML = projects.map(project => `
                    <div class="content-item">
                        <div class="content-item-header">
                            <h4>${project.title}</h4>
                            <div class="content-actions">
                                <button class="btn-secondary edit-project" data-id="${project._id}">Edit</button>
                                <button class="btn-logout delete-project" data-id="${project._id}">Delete</button>
                            </div>
                        </div>
                        <p>${project.description}</p>
                        <div class="content-meta">
                            <span>üìÖ ${project.startDate} - ${project.endDate || 'Present'}</span>
                            ${project.images && project.images.length > 0 ? `<span>üñºÔ∏è ${project.images.length} image(s)</span>` : ''}
                        </div>
                        ${project.tags && project.tags.length > 0 ? `
                            <div class="content-tags">
                                ${project.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                            </div>
                        ` : ''}
                    </div>
                `).join('');

                attachProjectListeners();
            } catch (error) {
                console.error('Error loading projects:', error);
            }
        }

        // Show Add/Edit Project Modal
        document.getElementById('addProjectBtn').addEventListener('click', () => {
            document.getElementById('projectModalTitle').textContent = 'Add New Project';
            document.getElementById('editProjectId').value = '';
            document.getElementById('projectTitle').value = '';
            document.getElementById('projectDescription').value = '';
            document.getElementById('projectTags').value = '';
            document.getElementById('projectStartDate').value = '';
            document.getElementById('projectEndDate').value = '';
            currentProjectImages = [];
            updateProjectImagesGrid();
            document.getElementById('projectModal').style.display = 'flex';
        });

        async function editProject(projectId) {
            try {
                const projects = await apiService.getProjects();
                const project = projects.find(p => p._id === projectId);

                if (project) {
                    document.getElementById('projectModalTitle').textContent = 'Edit Project';
                    document.getElementById('editProjectId').value = project._id;
                    document.getElementById('projectTitle').value = project.title;
                    document.getElementById('projectDescription').value = project.description;
                    document.getElementById('projectTags').value = project.tags ? project.tags.join(', ') : '';
                    document.getElementById('projectStartDate').value = project.startDate;
                    document.getElementById('projectEndDate').value = project.endDate || '';
                    currentProjectImages = project.images || [];
                    updateProjectImagesGrid();
                    document.getElementById('projectModal').style.display = 'flex';
                }
            } catch (error) {
                console.error('Error fetching project details:', error);
            }
        }

        // Add Project Image
        document.getElementById('addProjectImageBtn').addEventListener('click', () => {
            if (currentProjectImages.length >= 3) {
                showToast('Maximum 3 images allowed', 'error');
                return;
            }
            document.getElementById('projectImageInput').click();
        });

        document.getElementById('projectImageInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file && currentProjectImages.length < 3) {
                const compressed = await compressImage(file, 800);
                currentProjectImages.push(compressed);
                updateProjectImagesGrid();
                e.target.value = '';
            }
        });

        function updateProjectImagesGrid() {
            const grid = document.getElementById('projectImagesGrid');
            grid.innerHTML = currentProjectImages.map((img, i) => `
                <div class="image-grid-item">
                    <img src="${img}" alt="Project image">
                    <button class="remove-image-btn" data-index="${i}">√ó</button>
                </div>
            `).join('');

            grid.querySelectorAll('.remove-image-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const index = parseInt(btn.dataset.index);
                    currentProjectImages.splice(index, 1);
                    updateProjectImagesGrid();
                });
            });
        }

        // Save Project
        document.getElementById('saveProject').addEventListener('click', async () => {
            const title = document.getElementById('projectTitle').value.trim();
            const description = document.getElementById('projectDescription').value.trim();
            const tags = document.getElementById('projectTags').value.split(',').map(t => t.trim()).filter(t => t);
            const startDate = document.getElementById('projectStartDate').value;
            const endDate = document.getElementById('projectEndDate').value;
            const editId = document.getElementById('editProjectId').value;

            if (!title || !description) {
                showToast('Title and description are required', 'error');
                return;
            }

            const projectData = {
                title,
                description,
                tags,
                startDate,
                endDate: endDate || null,
                current: !endDate,
                images: currentProjectImages
            };

            try {
                if (editId) {
                    await apiService.updateProject(editId, projectData);
                } else {
                    await apiService.addProject(projectData);
                }

                document.getElementById('projectModal').style.display = 'none';
                loadProjects();
                showToast(editId ? 'Project updated!' : 'Project added!', 'success');
            } catch (error) {
                showToast('Error saving project', 'error');
            }
        });

        async function deleteProject(projectId) {
            if (confirm('Are you sure you want to delete this project?')) {
                try {
                    await apiService.deleteProject(projectId);
                    loadProjects();
                    showToast('Project deleted', 'success');
                } catch (error) {
                    showToast('Error deleting project', 'error');
                }
            }
        }

        function attachProjectListeners() {
            document.querySelectorAll('.edit-project').forEach(btn => {
                btn.addEventListener('click', () => editProject(btn.dataset.id));
            });
            document.querySelectorAll('.delete-project').forEach(btn => {
                btn.addEventListener('click', () => deleteProject(btn.dataset.id));
            });
        }

        document.getElementById('cancelProject').addEventListener('click', () => {
            document.getElementById('projectModal').style.display = 'none';
        });

        // ========== CERTIFICATIONS MANAGEMENT ==========
        let currentCertImage = null;

        async function loadCertifications() {
            try {
                const certs = await apiService.getCertifications();
                const container = document.getElementById('certificationsList');

                if (!certs || certs.length === 0) {
                    container.innerHTML = '<p class="empty-state">No certifications yet. Click "Add New Certification" to get started.</p>';
                    return;
                }

                container.innerHTML = certs.map(cert => `
                    <div class="content-item">
                        <div class="content-item-header">
                            <h4>${cert.name}</h4>
                            <div class="content-actions">
                                <button class="btn-secondary edit-cert" data-id="${cert._id}">Edit</button>
                                <button class="btn-logout delete-cert" data-id="${cert._id}">Delete</button>
                            </div>
                        </div>
                        ${cert.image ? `<div class="content-meta"><span>üñºÔ∏è Image uploaded</span></div>` : ''}
                    </div>
                `).join('');

                attachCertListeners();
            } catch (error) {
                console.error('Error loading certifications:', error);
            }
        }

        // Add Certification Button
        document.getElementById('addCertBtn').addEventListener('click', () => {
            document.getElementById('certModalTitle').textContent = 'Add New Certification';
            document.getElementById('editCertId').value = '';
            document.getElementById('certName').value = '';
            document.getElementById('certIssuer').value = '';
            document.getElementById('certDate').value = '';
            document.getElementById('certUrl').value = '';
            currentCertImage = null;
            document.getElementById('certModal').style.display = 'flex';
        });

        // Edit Certification
        async function editCert(certId) {
            try {
                const certs = await apiService.getCertifications();
                const cert = certs.find(c => c._id === certId);

                if (cert) {
                    document.getElementById('certModalTitle').textContent = 'Edit Certification';
                    document.getElementById('editCertId').value = cert._id;
                    document.getElementById('certName').value = cert.name;
                    document.getElementById('certIssuer').value = cert.issuer || '';
                    document.getElementById('certDate').value = cert.date || '';
                    document.getElementById('certUrl').value = cert.url || '';
                    currentCertImage = cert.image || null;
                    document.getElementById('certModal').style.display = 'flex';
                }
            } catch (error) {
                console.error('Error fetching cert details:', error);
            }
        }

        // Delete Certification
        async function deleteCert(certId) {
            if (confirm('Are you sure you want to delete this certification?')) {
                try {
                    await apiService.deleteCertification(certId);
                    loadCertifications();
                    showToast('Certification deleted', 'success');
                } catch (error) {
                    showToast('Error deleting certification', 'error');
                }
            }
        }

        // Save Certification
        document.getElementById('saveCert').addEventListener('click', async () => {
            const name = document.getElementById('certName').value.trim();
            const issuer = document.getElementById('certIssuer').value.trim();
            const date = document.getElementById('certDate').value.trim();
            const url = document.getElementById('certUrl').value.trim();
            const editId = document.getElementById('editCertId').value;

            if (!name) {
                showToast('Certification name is required', 'error');
                return;
            }

            const certData = {
                name,
                issuer,
                date,
                url,
                image: currentCertImage
            };

            try {
                if (editId) {
                    await apiService.updateCertification(editId, certData);
                } else {
                    await apiService.addCertification(certData);
                }

                document.getElementById('certModal').style.display = 'none';
                loadCertifications();
                showToast(editId ? 'Certification updated!' : 'Certification added!', 'success');
            } catch (error) {
                showToast('Error saving certification', 'error');
            }
        });

        // Cert Image Upload Button
        document.getElementById('certImageBtn').addEventListener('click', () => {
            document.getElementById('certImageInput').click();
        });

        // Cert Image Input Change
        document.getElementById('certImageInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                const compressed = await compressImage(file, 800);
                currentCertImage = compressed;
                showToast('Image staged for save', 'info');
            }
        });

        function attachCertListeners() {
            document.querySelectorAll('.edit-cert').forEach(btn => {
                btn.addEventListener('click', () => editCert(btn.dataset.id));
            });
            document.querySelectorAll('.delete-cert').forEach(btn => {
                btn.addEventListener('click', () => deleteCert(btn.dataset.id));
            });
        }

        document.getElementById('cancelCert').addEventListener('click', () => {
            document.getElementById('certModal').style.display = 'none';
        });

        // Initialize
        loadAnalytics();
        loadRecentPosts();
        loadProfile();
        loadProjects();
        loadCertifications();
    </script>
</body>

</html>